#!/bin/bash
notify-send "Starting backup"
{% for host in groups[backup_slave_group_name] %}
{% for source in hostvars[host][backup_slave_sources_name] %}
echo '===============================================' >> /var/log/backup/{{ host }}.log
date -Is  >> /var/log/backup/{{ host }}.log
rsync --stats {{ backup_master_rsync_opts | default(source.rsync_opts) }} {{ source.user }}@{{ hostvars[host]['ansible_host'] }}:{{ source.path }} {{ backup_device.path }}/{{ host }} >> /var/log/backup/{{ host }}.log
{% endfor %}
{% endfor %}
notify-send -c "transfer.complete" "Backup finished, please remove backup device"